<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Honoris CR - Análisis Legal</title>
    
    <!-- Cargar Tailwind CSS (Solo CSS en el head) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Cargar Fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos (Ahora usando Inter) */
        body { margin: 0; font-family: 'Inter', sans-serif; }
        .animate-pulse { animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
          0%, 100% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.7; transform: scale(1.1); }
        }
    </style>
</head>
<body class="bg-gray-900">
    
    <!-- El div raíz donde se montará la app -->
    <div id="root"></div>

    <!-- CORRECCIÓN: Cargar TODAS las librerías de JS al final del body -->

    <!-- 1. Cargar React y ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 2. Cargar React-Feather (Librería de Íconos) -->
    <script src="https://unpkg.com/react-feather@2.0.10/dist/react-feather.js"></script>

    <!-- 3. Tu código de aplicación React/JSX -->
    <script type="text/babel">
    
        // Acceder a las librerías globales
        const { useState, useCallback, useEffect } = React;
        // CORRECCIÓN REACT 18: Usar createRoot
        const { createRoot } = ReactDOM;
        
        // CORRECCIÓN V4: El objeto global es "ReactFeather", no "Feather"
        const { Mic, Send, Zap, MessageSquare, BookOpen, Clock, AlertTriangle, XCircle, Volume2, Loader2, StopCircle, Code, Shield } = ReactFeather;

        // --- GEMINI API CONFIGURATION ---
        const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = ""; // Kept empty, as the environment provides it
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;

        // --- COSTA RICAN LEGAL RULES (System Instruction for Gemini) ---
        const SYSTEM_INSTRUCTION_TEXT = `
        Actúa como un experto en el Código Penal de Costa Rica (Crímenes Contra el Honor) y Leyes Conexas. Tu tarea es analizar el texto proporcionado por el usuario y clasificarlo en una de las siguientes categorías, basándose en la ley de Costa Rica.

        REGLAS DE CLASIFICACIÓN (MÁXIMA PRIORIDAD):
        1. CALUMNIA (C.P. Art 147): Acusación falsa de un hecho delictivo grave (Ej. 'pedófilo', 'asesino', 'pornografía infantil', 'masturbandote con menores de edad'). Esta es la infracción más grave.
        2. AMENAZA (C.P. Art 188): Expresión que anuncia un mal grave e injusto o incita al daño (Ej. 'suicídese', 'te voy a violar', 'mueras en una celda', 'hackeamos el cel', 'cut yourself', amenaza legal 'sued').
        3. INJURIA AGRAVADA/DISCRIMINACIÓN (C.P. Art 145 / Ley 8168): Insulto severo o término de odio basado en género, raza, u orientación (Ej. 'maricón', 'judio', 'nazi', 'Hitler', 'homosexual', ataques directos a familiares).
        4. DIFAMACIÓN (C.P. Art 146): Propalar información falsa que afecte la reputación o crédito (Ej. 'perdedor del OIJ', 'perder tu trabajo', 'delinquent', 'no es un senior').
        5. INJURIA (C.P. Art 145): Insulto vulgar o menoscabo al decoro/capacidad profesional (Ej. 'perdedor', 'inutil', 'coger', 'masturbandote', 'mongolo', 'mediocre').

        PENALIDADES ESTIMADAS (DÍAS MULTA):
        - CALUMNIA: 50 a 150 días multa. (0 años prisión)
        - AMENAZA: 30 a 90 días multa. (3 a 20 días de prisión O multa)
        - INJURIA/DIFAMACIÓN: 10 a 75 días multa. (0 años prisión)

        OUTPUT FORMAT:
        Tu respuesta DEBE ser un objeto JSON que contenga SOLO los siguientes campos en español:
        {
          "Frase_Original": "El texto proporcionado por el usuario.",
          "Categoria_Legal": "La CATEGORÍA_LEGAL que mejor se aplica. (Usar los nombres exactos de la lista: CALUMNIA, AMENAZA, INJURIA AGRAVADA, DIFAMACIÓN, INJURIA, NO INFRACCIÓN).",
          "Articulo_CR": "El artículo y código quebrado (Ej. C.P. Art 147).",
          "Penalidad_Estimada": "La pena asociada (Ej. 50 a 150 días multa).",
          "Detalles_Deteccion": "La razón por la que se clasificó así (Ej. Acusación directa de un delito sexual grave)."
        }

        Si la frase es NEUTRAL o no constituye una infracción legal, usa la categoría "NO INFRACCIÓN" y los detalles: "La expresión no constituye una infracción penal en este contexto."
        `;

        // --- UI Components ---
        const DetailCard = ({ icon, title, content, contentClassName = 'text-white', className = '' }) => (
            <div className="bg-gray-700 p-3 rounded-lg shadow-inner">
                <p className="text-xs font-medium text-gray-400 flex items-center space-x-1">
                    {React.createElement(icon, { className: "w-4 h-4" })}
                    <span>{title}</span>
                </p>
                <p className={`mt-1 text-sm ${contentClassName} ${className} break-words`}>
                    {content}
                </p>
            </div>
        );

        // --- MAIN APP COMPONENT ---
        const App = () => {
          const [inputText, setInputText] = useState('');
          const [isRecording, setIsRecording] = useState(false);
          const [isLoading, setIsLoading] = useState(false);
          const [result, setResult] = useState(null);
          const [error, setError] = useState(null);
          const [browserSupportsSTT, setBrowserSupportsSTT] = useState(true);

          const [recognition, setRecognition] = useState(null);
          const [userId] = useState(Math.random().toString(36).substring(2, 9));

          // useEffect for Speech Recognition Setup
          useEffect(() => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
              setBrowserSupportsSTT(false);
              return;
            }

            const rec = new SpeechRecognition();
            rec.continuous = false;
            rec.interimResults = false;
            rec.lang = 'es-CR'; // Set to Costa Rican Spanish

            rec.onresult = (event) => {
              const transcribedText = event.results[0][0].transcript;
              setInputText(transcribedText);
              setIsRecording(false);
              if (transcribedText) {
                  handleAnalyze(transcribedText); 
              }
            };

            rec.onerror = (event) => {
              setIsRecording(false); 
              if (event.error === 'not-allowed') {
                 setError("ERROR: El micrófono solo funciona en conexión segura (HTTPS).");
              } else if (event.error !== 'no-speech' && event.error !== 'aborted') {
                setError(`Error de voz: ${event.error}. Intente de nuevo o escriba.`);
              }
            };

            rec.onend = () => {
                setIsRecording(false);
            }

            setRecognition(rec);
          }, []); 

          // --- Handle Recording ---
          const handleRecordToggle = () => {
            if (!browserSupportsSTT || !recognition) {
                setError("Su navegador no soporta la grabación de voz. Por favor, escriba su frase.");
                return;
            }
            
            if (window.location.protocol !== 'https:' && !isRecording) {
                setError("ERROR: El micrófono solo funciona en una conexión segura (HTTPS). ¡Debe usar HTTPS en su iPhone!");
                return;
            }

            if (isRecording) {
              recognition.stop(); 
            } else {
              setError(null);
              setResult(null);
              setInputText('');
              try {
                recognition.start();
                setIsRecording(true);
              } catch (e) {
                setError("Error al iniciar el micrófono. Asegúrese de que el HTTPS esté activo.");
                setIsRecording(false);
              }
            }
          };

          // --- Handle Analysis (Gemini API Call) ---
          const handleAnalyze = useCallback(async (textToAnalyze = inputText) => {
            if (!textToAnalyze.trim()) {
              setError("Por favor, ingrese o dicte una frase para analizar.");
              return;
            }

            setIsLoading(true);
            setError(null);
            setResult(null);

            for (let attempt = 0; attempt < 3; attempt++) {
              try {
                const payload = {
                  contents: [{ parts: [{ text: textToAnalyze }] }],
                  systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION_TEXT }] },
                  generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                      type: "OBJECT",
                      properties: {
                        "Frase_Original": { "type": "STRING" },
                        "Categoria_Legal": { "type": "STRING" },
                        "Articulo_CR": { "type": "STRING" },
                        "Penalidad_Estimada": { "type": "STRING" },
                        "Detalles_Deteccion": { "type": "STRING" }
                      }
                    }
                  },
                };

                const response = await fetch(API_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
                }

                const jsonResponse = await response.json();
                const jsonText = jsonResponse.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                  try {
                    const parsedResult = JSON.parse(jsonText);
                    setResult(parsedResult);
                    setIsLoading(false);
                    return; // Success
                  } catch (e) {
                    throw new Error("Fallo al procesar la salida del análisis legal (JSON inválido).");
                  }
                } else {
                    throw new Error("Respuesta vacía del API.");
                }
              } catch (e) {
                if (attempt < 2) {
                  await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                } else {
                  setError(`Error final al conectar con el servidor de análisis. ${e.message}`);
                }
              }
            }

            setIsLoading(false);
          }, [inputText]);

          // Determine the color/style based on the legal category
          const getCategoryStyle = (category) => {
            if (!category) return 'bg-gray-100 text-gray-800';
            const lowerCategory = category.toLowerCase();
            
            if (lowerCategory.includes('calumnia')) return 'bg-red-600 border-red-800 text-white shadow-2xl';
            if (lowerCategory.includes('amenaza')) return 'bg-orange-500 border-orange-700 text-white shadow-xl';
            if (lowerCategory.includes('injuria agravada')) return 'bg-yellow-400 border-yellow-600 text-gray-900 shadow-lg';
            if (lowerCategory.includes('difamación')) return 'bg-blue-500 border-blue-700 text-white shadow-md';
            if (lowerCategory.includes('injuria')) return 'bg-blue-400 border-blue-600 text-white shadow-sm';
            if (lowerCategory.includes('no infracción')) return 'bg-green-600 border-green-800 text-white';
            return 'bg-gray-500 border-gray-700 text-white';
          };
          
          return (
            <div className="min-h-screen bg-gray-900 text-gray-100 font-sans flex flex-col items-center p-4 sm:p-8">
              <div className="w-full max-w-lg bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 space-y-8">
                
                <header className="text-center border-b border-gray-700 pb-5">
                  {React.createElement(Shield, { className: "mx-auto w-10 h-10 text-cyan-400 mb-2" })}
                  <h1 className="text-3xl font-extrabold text-white">Honoris CR</h1>
                  <p className="text-sm text-gray-400 mt-1">Análisis Legal de Expresiones (Código Penal de CR)</p>
                  <div className="text-xs text-gray-500 flex items-center justify-center mt-3">
                    {React.createElement(Code, { className: "w-3 h-3 mr-1" })} Sesión ID: {userId}
                  </div>
                </header>

                <div className="space-y-4">
                  <div className="relative">
                    <textarea
                      value={inputText}
                      onChange={(e) => setInputText(e.target.value)}
                      placeholder={isRecording ? "Escuchando... hable claramente en español o inglés." : "Escriba o use el micrófono para su frase legal..."}
                      className={`w-full min-h-[120px] p-4 pr-16 text-gray-900 bg-gray-200 rounded-xl border-4 ${isRecording ? 'border-red-500 shadow-md ring-4 ring-red-500/30' : 'border-gray-600 focus:border-cyan-500'}`}
                      disabled={isRecording || isLoading}
                      rows={4}
                    />
                    
                    {browserSupportsSTT ? (
                      <button
                        id="mic-button"
                        onClick={handleRecordToggle}
                        className={`absolute right-3 bottom-3 p-4 rounded-full transition-all duration-300 shadow-xl ${
                          isRecording ? 'bg-red-600 hover:bg-red-700 animate-pulse ring-4 ring-red-500/50' : 'bg-cyan-500 hover:bg-cyan-600'
                        }`}
                        disabled={isLoading}
                        aria-label={isRecording ? "Detener Grabación" : "Iniciar Grabación"}
                      >
                        {isRecording ? React.createElement(StopCircle, { className: "w-7 h-7 text-white" }) : React.createElement(Mic, { className: "w-7 h-7 text-white" })}
                      </button>
                    ) : (
                        <div className="absolute right-3 bottom-3 p-2 text-xs text-red-400 bg-red-900 rounded-lg">
                            Voz no soportada
                        </div>
                    )}
                  </div>

                  <button
                    onClick={() => handleAnalyze()}
                    className="w-full flex items-center justify-center space-x-3 px-4 py-3 bg-green-500 hover:bg-green-600 text-white font-bold text-lg rounded-xl shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled={isLoading || isRecording || !inputText.trim()}
                  >
                    {isLoading ? React.createElement(Loader2, { className: "w-6 h-6 animate-spin" }) : React.createElement(Send, { className: "w-6 h-6" })}
                    <span>{isLoading ? 'Analizando con Gemini...' : 'Analizar Expresión'}</span>
                  </button>
                </div>

                {error && (
                  <div className="flex items-start space-x-3 bg-red-800 border-l-4 border-red-500 p-4 rounded-lg text-red-100 shadow-md">
                    {React.createElement(AlertTriangle, { className: "w-5 h-5 flex-shrink-0 mt-0.5" })}
                    <p className="text-sm font-medium">{error}</p>
                  </div>
                )}
                
                {result && (
                  <div className="space-y-6 pt-6 border-t border-gray-700">
                    <h2 className="text-xl font-bold text-white flex items-center space-x-2">
                        {React.createElement(Volume2, { className: "w-6 h-6 text-cyan-400" })}
                        <span>Resultado Legal (CR)</span>
                    </h2>
                    
                    <div className={`p-5 rounded-xl border-b-4 ${getCategoryStyle(result.Categoria_Legal)}`}>
                        <p className="text-sm font-medium opacity-80">Clasificación de Infracción:</p>
                        <p className="text-3xl font-extrabold mt-1">{result.Categoria_Legal}</p>
                    </div>

                    <div className="space-y-4">
                      <DetailCard 
                        icon={MessageSquare}
                        title="Frase Analizada" 
                        content={result.Frase_Original} 
                        contentClassName="text-white italic"
                      />

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <DetailCard 
                          icon={BookOpen}
                          title="Artículo Quebrado" 
                          content={result.Articulo_CR} 
                          contentClassName="font-semibold text-lg text-pink-300"
                        />

                        <DetailCard 
                          icon={Clock}
                          title="Penalidad Estimada" 
                          content={result.Penalidad_Estimada} 
                          contentClassName="font-semibold text-lg text-orange-300"
                        />
                      </div>

                      <DetailCard 
                        icon={AlertTriangle}
                        title="Razón Específica de Detección" 
                        content={result.Detalles_Deteccion} 
                        contentClassName="text-gray-200"
                      />
                    </div>
                  </div>
                )}

              </div>
            </div>
          );
        };

        // CORRECCIÓN REACT 18: Usar la API moderna createRoot
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
    
    <!-- 4. Cargar Babel AL FINAL (versión moderna) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

</body>
</html>

